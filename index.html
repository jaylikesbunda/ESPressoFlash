<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ESPressoFlash</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet"> <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.1/font/bootstrap-icons.css"> <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="styles.css"> <!-- Custom CSS -->
    <style>
        /* Loading Animation CSS - Moved from loading-animation.js */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: #121223; /* Match body bg */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1; /* Start visible */
            transition: opacity 0.5s ease; /* Fade out transition */
            visibility: visible; /* Start visible */
        }

        .loading-overlay.hidden { /* Class to hide */
             opacity: 0;
             visibility: hidden;
         }

        .loading-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        .loading-logo {
            animation: float 3s ease-in-out infinite;
        }

        .steam-path {
            opacity: 0.8;
            animation: steam 2s ease-in-out infinite;
        }

        .steam-path:nth-child(2) {
            animation-delay: 0.3s;
        }

        .steam-path:nth-child(3) {
            animation-delay: 0.6s;
        }

        .loading-text {
            font-size: 2rem;
            font-weight: 600;
            color: #c3865f; /* Match primary color */
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 5px solid rgba(195, 134, 95, 0.2); /* Lighter primary */
            border-radius: 50%;
            border-top-color: #c3865f; /* Primary color */
            animation: spin 1s linear infinite;
        }

        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-10px); }
            100% { transform: translateY(0px); }
        }

        @keyframes steam {
            0% { transform: translateY(0) scaleX(1); opacity: 0; }
            20% { opacity: 0.8; }
            40% { transform: translateY(-10px) scaleX(1.1); }
            80% { opacity: 0; }
            100% { transform: translateY(-20px) scaleX(1.5); opacity: 0; }
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        /* Style for the stuck button */
        .stuck-button {
            margin-left: auto; /* Push the button to the right */
        }
        /* Added rule for modal list item spacing */
        .modal-body ul li {
            margin-bottom: 0.6rem; /* Adjust this value as needed */
        }
        .modal-body ul {
            margin-bottom: 1rem; /* Add some space after the list */
        }
    </style>
</head>
<body>
    <!-- Loading Container -->
    <div id="loading-container">
         <div class="loading-overlay">
             <div class="loading-content">
                 <div class="loading-logo">
                     <svg width="120" height="120" viewBox="0 0 120 120" fill="none" xmlns="http://www.w3.org/2000/svg">
                         <!-- Coffee cup shape -->
                         <path d="M30 40 L30 90 A20 20 0 0 0 50 110 L70 110 A20 20 0 0 0 90 90 L90 40 Z" stroke="#c3865f" stroke-width="4" fill="#1e1e2f"/>
                         <!-- Cup handle -->
                         <path d="M90 50 Q110 50 110 70 Q110 90 90 90" stroke="#c3865f" stroke-width="4" fill="none"/>
                         <!-- Coffee steam -->
                         <path class="steam-path" d="M45 30 Q50 20 55 30" stroke="#c3865f" stroke-width="2" fill="none"/>
                         <path class="steam-path" d="M60 30 Q65 15 70 30" stroke="#c3865f" stroke-width="2" fill="none"/>
                         <path class="steam-path" d="M75 30 Q80 20 85 30" stroke="#c3865f" stroke-width="2" fill="none"/>
                     </svg>
                 </div>
                 <div class="loading-text">ESPressoFlash</div>
                 <div class="loading-spinner"></div>
             </div>
         </div>
     </div>

    <div class="container-fluid">
        <header class="py-3 text-center">
            <h1>ESPressoFlash</h1>
            <p class="text-muted">Flash your ESP32 quickly and easily</p>
        </header>

        <main>
            <div class="stepper-container"> <!-- Step navigation -->
                <div class="stepper">
                    <div class="stepper-item">
                        <div class="stepper-circle active" id="stepper1">1</div>
                        <div class="stepper-line"></div>
                    </div>
                    <div class="stepper-item">
                        <div class="stepper-circle" id="stepper2">2</div>
                        <div class="stepper-line"></div>
                    </div>
                    <div class="stepper-item">
                        <div class="stepper-circle" id="stepper3">3</div>
                        <div class="stepper-line"></div>
                    </div>
                    <div class="stepper-item">
                        <div class="stepper-circle" id="stepper4">4</div>
                    </div>
                </div>
                <div class="stepper-labels">
                    <div>Select Device</div>
                    <div>Connect</div>
                    <div>Configure</div>
                    <div>Flash</div>
                </div>
            </div>

            <div class="step-container active" id="step1"> <!-- Step 1: Select Device -->
                <h2>Select Your ESP32 Variant</h2>
                <p>Choose the ESP32 variant you want to flash</p>
                
                <div class="row device-cards">
                    <!-- Common Devices -->
                    <div class="col-md-4 mb-4">
                        <div class="card device-card" data-device="ESP32">
                            <div class="card-body">
                                <h5 class="card-title device-name">ESP32</h5>
                                <p class="card-text">Original ESP32 with dual core up to 240MHz</p>
                                <div class="chip-details">
                                    <span><i class="bi bi-cpu"></i> Dual Core</span>
                                    <span><i class="bi bi-speedometer"></i> 240MHz</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card device-card" data-device="ESP32-S2">
                            <div class="card-body">
                                <h5 class="card-title device-name">ESP32-S2</h5>
                                <p class="card-text">Single core with enhanced security features</p>
                                <div class="chip-details">
                                    <span><i class="bi bi-cpu"></i> Single Core</span>
                                    <span><i class="bi bi-speedometer"></i> 240MHz</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card device-card" data-device="ESP32-S3">
                            <div class="card-body">
                                <h5 class="card-title device-name">ESP32-S3</h5>
                                <p class="card-text">Dual core with AI acceleration and rich peripherals</p>
                                <div class="chip-details">
                                    <span><i class="bi bi-cpu"></i> Dual Core</span>
                                    <span><i class="bi bi-speedometer"></i> 240MHz</span>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="col-md-4 mb-4">
                        <div class="card device-card" data-device="ESP32-C3">
                            <div class="card-body">
                                <h5 class="card-title device-name">ESP32-C3</h5>
                                <p class="card-text">RISC-V based low-power chip with Wi-Fi and Bluetooth LE</p>
                                <div class="chip-details">
                                    <span><i class="bi bi-cpu"></i> RISC-V</span>
                                    <span><i class="bi bi-speedometer"></i> 160MHz</span>
                                </div>
                            </div>
                        </div>
                    </div>
                     <div class="col-md-4 mb-4">
                        <div class="card device-card" data-device="ESP32-C5">
                            <div class="card-body">
                                <h5 class="card-title device-name">ESP32-C5</h5>
                                <p class="card-text">RISC-V SoC with Wi-Fi 6 (2.4/5GHz), BT 5, Thread/Zigbee</p>
                                <div class="chip-details">
                                    <span><i class="bi bi-cpu"></i> RISC-V</span>
                                    <span><i class="bi bi-speedometer"></i> 240MHz</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 mb-4">
                        <div class="card device-card" data-device="ESP32-C6">
                            <div class="card-body">
                                <h5 class="card-title device-name">ESP32-C6</h5>
                                <p class="card-text">RISC-V based SoC with Wi-Fi 6 and Bluetooth 5 LE</p>
                                <div class="chip-details">
                                    <span><i class="bi bi-cpu"></i> RISC-V</span>
                                    <span><i class="bi bi-speedometer"></i> 160MHz</span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <!-- End Common Devices -->

                    <!-- Hidden Container for Rare Devices -->
                    <div id="rareDevicesContainer" class="row d-none w-100"> 
                         <div class="col-md-4 mb-4">
                            <div class="card device-card" data-device="ESP32-C2">
                                <div class="card-body">
                                    <h5 class="card-title device-name">ESP32-C2</h5>
                                    <p class="card-text">RISC-V low-power chip with Wi-Fi 4 and Bluetooth 5</p>
                                    <div class="chip-details">
                                        <span><i class="bi bi-cpu"></i> RISC-V</span>
                                        <span><i class="bi bi-speedometer"></i> 120MHz</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="card device-card" data-device="ESP32-H2">
                                <div class="card-body">
                                    <h5 class="card-title device-name">ESP32-H2</h5>
                                    <p class="card-text">RISC-V SoC with Thread/Zigbee & Bluetooth 5 LE (No Wi-Fi)</p>
                                    <div class="chip-details">
                                        <span><i class="bi bi-cpu"></i> RISC-V</span>
                                        <span><i class="bi bi-speedometer"></i> 96MHz</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="card device-card" data-device="ESP32-P4">
                                <div class="card-body">
                                    <h5 class="card-title device-name">ESP32-P4</h5>
                                    <p class="card-text">High-performance RISC-V for AI/Media (No Wi-Fi/BT)</p>
                                    <div class="chip-details">
                                        <span><i class="bi bi-cpu"></i> Dual Core RISC-V</span>
                                        <span><i class="bi bi-speedometer"></i> 400MHz</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4 mb-4">
                            <div class="card device-card" data-device="ESP8266">
                                <div class="card-body">
                                    <h5 class="card-title device-name">ESP8266</h5>
                                    <p class="card-text">Classic low-cost Wi-Fi module</p>
                                    <div class="chip-details">
                                        <span><i class="bi bi-cpu"></i> Single Core</span>
                                        <span><i class="bi bi-speedometer"></i> 80MHz</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div> <!-- End Hidden Container -->
                </div>

                <!-- Show More/Less Buttons -->
                <div class="text-center mt-2 mb-4">
                    <button id="showMoreDevicesButton" class="btn btn-outline-espresso">
                        <i class="bi bi-chevron-down"></i> Show More Devices
                    </button>
                    <button id="showLessDevicesButton" class="btn btn-outline-espresso d-none">
                        <i class="bi bi-chevron-up"></i> Show Less Devices
                    </button>
                </div>
                
                <div class="navigation-buttons">
                    <button class="btn btn-sm btn-outline-info stuck-button" data-step="1">
                        <i class="bi bi-question-circle"></i> I'm Stuck
                    </button>
                    <button id="nextToStep2" class="btn btn-primary ms-2" disabled>
                        <i class="bi bi-arrow-right"></i> Continue
                    </button>
                </div>
            </div>

            <div class="step-container" id="step2"> <!-- Step 2: Connect -->
                <h2>Connect to <span id="selectedDeviceConnect"></span></h2>
                <p>Connect your device to your computer via USB and click the Connect button</p>
                
                <div class="card settings-card">
                    <div class="card-body">
                        <h5 class="card-title">Connection Settings</h5>
                        
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <label for="baudrate" class="form-label">Baud Rate</label>
                                <select id="baudrate" class="form-select">
                                    <option value="9600">9600</option>
                                    <option value="19200">19200</option>
                                    <option value="38400">38400</option>
                                    <option value="57600">57600</option>
                                    <option selected value="115200">115200</option>
                                    <option value="230400">230400</option>
                                    <option value="460800">460800</option>
                                    <option value="921600">921600</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label for="resetMethod" class="form-label">Reset Method</label>
                                <select id="resetMethod" class="form-select">
                                    <option value="none">None (Power Cycle)</option>
                                    <option selected value="normal">Normal (RTS/DTR)</option>
                                    <option value="hardware">Hardware (RTS&DTR)</option>
                                </select>
                            </div>
                        </div>
                        
                        <div id="chipInfo">
                            <span class="status-indicator status-disconnected"></span> Disconnected
                        </div>
                        
                        <div class="button-row mt-3">
                            <button id="connectButton" class="btn btn-primary">
                                <i class="bi bi-usb-symbol"></i> Connect
                            </button>
                            <button id="disconnectButton" class="btn btn-secondary" disabled>
                                <i class="bi bi-x-circle"></i> Disconnect
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button id="backToStep1" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-sm btn-outline-info stuck-button" data-step="2">
                        <i class="bi bi-question-circle"></i> I'm Stuck
                    </button>
                    <button id="nextToStep3" class="btn btn-primary ms-2" disabled>
                        <i class="bi bi-arrow-right"></i> Continue
                    </button>
                </div>
            </div>

            <div class="step-container" id="step3"> <!-- Step 3: Configure -->
                <h2>Configure Flash Settings</h2>
                <p>Select a firmware source or upload files manually.</p>

                <div class="card mb-3">
                    <div class="card-body">
                        <label for="firmwareSourceSelect" class="form-label">Firmware Source</label>
                        <select id="firmwareSourceSelect" class="form-select">
                            <option value="manual" selected>Upload Manually</option>
                            <option value="ghostesp">Download GhostESP (Latest)</option>
                            <option value="marauder">Download Marauder (Latest)</option>
                        </select>
                    </div>
                </div>

                <div id="ghostEspDownloadSection" class="card mb-3 d-none">
                    <div class="card-body">
                        <h5 class="card-title">GhostESP Options</h5>
                        <div class="mb-3">
                            <label for="ghostEspVariantSelect" class="form-label">Select GhostESP Variant</label>
                            <select id="ghostEspVariantSelect" class="form-select"> 
                                <option value="">-- Loading variants... --</option>
                            </select>
                            <a id="ghostEspDownloadLink" class="btn btn-secondary mt-2 disabled" href="#" target="_blank" role="button"> 
                                <i class="bi bi-github me-1"></i> Download Selected Variant ZIP
                            </a>
                             <small class="form-text text-muted d-block mt-1">Download the ZIP, extract it, then use "Upload Manually" below to select the .bin files.</small>
                        </div>
                    </div>
                </div>

                <div id="marauderDownloadSection" class="card mb-3 d-none">
                    <div class="card-body">
                        <h5 class="card-title">Marauder Options</h5>
                        <div class="mb-3">
                            <label for="marauderVariantSelect" class="form-label">Select Marauder Binary</label>
                            <select id="marauderVariantSelect" class="form-select">
                                <option value="">-- Loading variants... --</option>
                            </select>
                            <a id="marauderDownloadLink" class="btn btn-secondary mt-2 disabled" href="#" target="_blank" role="button">
                                <i class="bi bi-github me-1"></i> Download Selected Binary
                            </a>
                            <small class="form-text text-muted d-block mt-1">Download the correct .bin file for your hardware, then use "Upload Manually" below to select it (usually as the Application binary).</small>
                        </div>
                    </div>
                </div>

                <div id="manualUploadSection" class="card">
                    <div class="card-body">
                         <h5 class="card-title">Manual Upload</h5>
                        <div class="binary-type-toggle">
                            <button class="btn active" data-binary="app">
                                <i class="bi bi-file-earmark-binary"></i> Application
                            </button>
                            <button class="btn" data-binary="bootloader">
                                <i class="bi bi-hdd-network"></i> Bootloader
                            </button>
                            <button class="btn" data-binary="partition">
                                <i class="bi bi-table"></i> Partition Table
                            </button>
                        </div>
                        
                        <div id="appFirmware">
                            <div class="firmware-upload">
                                <div class="mb-3">
                                    <label for="appAddress" class="form-label">App Address</label>
                                    <input type="text" class="form-control" id="appAddress" value="0x10000">
                                </div>
                                <label for="appFile" class="custom-file-upload">
                                    <span><i class="bi bi-upload"></i> Upload App Binary</span>
                                </label>
                                <input type="file" id="appFile" accept=".bin">
                                <p id="appFileInfo" class="file-info">No file selected</p>
                            </div>
                        </div>
                        
                        <div id="bootloaderFirmware" class="d-none">
                            <div class="firmware-upload">
                                <div class="mb-3">
                                    <label for="bootloaderAddress" class="form-label">Bootloader Address</label>
                                    <input type="text" class="form-control" id="bootloaderAddress" value="0x1000">
                                </div>
                                <label for="bootloaderFile" class="custom-file-upload">
                                    <span><i class="bi bi-upload"></i> Upload Bootloader Binary</span>
                                </label>
                                <input type="file" id="bootloaderFile" accept=".bin">
                                <p id="bootloaderFileInfo" class="file-info">No file selected</p>
                            </div>
                        </div>
                        
                        <div id="partitionFirmware" class="d-none">
                            <div class="firmware-upload">
                                <div class="mb-3">
                                    <label for="partitionAddress" class="form-label">Partition Address</label>
                                    <input type="text" class="form-control" id="partitionAddress" value="0x8000">
                                </div>
                                <label for="partitionFile" class="custom-file-upload">
                                    <span><i class="bi bi-upload"></i> Upload Partition Binary</span>
                                </label>
                                <input type="file" id="partitionFile" accept=".bin">
                                <p id="partitionFileInfo" class="file-info">No file selected</p>
                            </div>
                        </div>
                    </div>
                </div>
                    
                <div class="card settings-card mt-3">
                    <div class="card-body">
                        <div class="d-flex justify-content-between align-items-center mb-0">
                            <h5 class="card-title mb-0">Flash Options</h5>
                            <button class="btn btn-sm btn-outline-secondary" type="button" 
                                    data-bs-toggle="collapse" data-bs-target="#flashOptionsCollapse" 
                                    aria-expanded="false" aria-controls="flashOptionsCollapse">
                                <i class="bi bi-gear"></i> Show Options
                            </button>
                        </div>
                        
                        <div class="collapse mt-3" id="flashOptionsCollapse">
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <label for="flashMode" class="form-label">Flash Mode</label>
                                    <select id="flashMode" class="form-select">
                                        <option value="qio">QIO</option>
                                        <option selected value="dio">DIO</option>
                                        <option value="dout">DOUT</option>
                                        <option value="qout">QOUT</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="flashFreq" class="form-label">Flash Freq</label>
                                    <select id="flashFreq" class="form-select">
                                        <option value="20m">20 MHz</option>
                                        <option selected value="40m">40 MHz</option>
                                        <option value="80m">80 MHz</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label for="flashSize" class="form-label">Flash Size</label>
                                    <select id="flashSize" class="form-select">
                                        <option value="1MB">1 MB</option>
                                        <option value="2MB">2 MB</option>
                                        <option selected value="4MB">4 MB</option>
                                        <option value="8MB">8 MB</option>
                                        <option value="16MB">16 MB</option>
                                    </select>
                                </div>
                            </div>
                            <div class="form-check mt-3">
                                <input class="form-check-input" type="checkbox" id="eraseAll" checked> 
                                <label class="form-check-label" for="eraseAll">
                                    Erase all flash before programming
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="navigation-buttons">
                    <button id="backToStep2" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-sm btn-outline-info stuck-button" data-step="3">
                        <i class="bi bi-question-circle"></i> I'm Stuck
                    </button>
                    <button id="nextToStep4" class="btn btn-primary ms-2">
                        <i class="bi bi-arrow-right"></i> Continue
                    </button>
                </div>
            </div>

            <div class="step-container" id="step4"> <!-- Step 4: Flash -->
                <h2>Flash Your Device</h2>
                <p>Ready to flash your device with the selected firmware</p>
                
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Flash Summary</h5>
                        <ul id="flashSummary">
                            <!-- Flash summary will be populated by JS -->
                        </ul>
                        
                        <div class="progress mb-1"> <!-- Reduced margin-bottom -->
                            <div id="flashProgress" class="progress-bar bg-success" role="progressbar" style="width: 0%"></div>
                        </div>
                        <div class="text-end mb-3"> <!-- Container for ETA -->
                            <small id="flashETA" class="text-muted"></small>
                        </div>
                        
                        <div class="action-buttons">
                            <button id="flashButton" class="btn btn-primary">
                                <i class="bi bi-lightning"></i> Flash Firmware
                            </button>
                            <button id="eraseButton" class="btn btn-danger">
                                <i class="bi bi-trash"></i> Erase Flash
                            </button>
                            <button id="resetButton" class="btn btn-secondary">
                                <i class="bi bi-arrow-repeat"></i> Reset Device
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="globalStatusIndicator" class="alert alert-warning d-none mt-3" role="alert"></div>

                <div class="navigation-buttons">
                    <button id="backToStep3" class="btn btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back
                    </button>
                    <button class="btn btn-sm btn-outline-info stuck-button" data-step="4">
                        <i class="bi bi-question-circle"></i> I'm Stuck
                    </button>
                    <button id="startOver" class="btn btn-outline-primary ms-2">
                        <i class="bi bi-arrow-repeat"></i> Start Over
                    </button>
                </div>
            </div>
            
            <div class="mt-4"> <!-- Terminal output -->
                <button class="btn btn-outline-secondary w-100" type="button" 
                        data-bs-toggle="collapse" data-bs-target="#terminal-container" 
                        aria-expanded="false" aria-controls="terminal-container">
                    <i class="bi bi-terminal"></i> Output Log <i class="bi bi-chevron-down ms-2"></i>
                </button>
                <div class="collapse" id="terminal-container">
                    <div class="terminal-header">
                        <h5><i class="bi bi-terminal"></i> Output Log</h5>
                    </div>
                    <pre id="terminal"></pre>
                </div>
            </div>
        </main>

        <footer class="py-3 text-center">
            <p>
                ESPressoFlash | <i class="bi bi-github"></i> <a href="https://github.com/jaylikesbunda/ESPressoFlash" target="_blank">GitHub</a>
                <br> 
                <span class="kofi-link">If you like using ESPresso, consider <a href="https://ko-fi.com/jaylikesbunda" target="_blank" rel="noopener noreferrer">buying me one! <i class="bi bi-cup-hot-fill"></i></a></span>
            </p>
        </footer>
    </div>
    <!-- Loading Container should be inside body but outside main container if needed -->
    <!-- <div id="loading-container"></div> --> <!-- Already added at the top -->

    <!-- Modals for "I'm Stuck" -->
    <!-- Step 1 Modal -->
    <div class="modal fade" id="stuckModalStep1" tabindex="-1" aria-labelledby="stuckModalStep1Label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stuckModalStep1Label">Help: Selecting Device</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Choose the type of ESP board you are using.</p>
                    <ul>
                        <li>Check the name printed on the chip (e.g., ESP32-S3).</li>
                        <li>Click the matching card below.</li>
                        <li>The "Continue" button will activate.</li>
                    </ul>
                    <!-- Updated Diagram -->
                    <div class="help-diagram">
                        <div class="help-step">
                            <i class="bi bi-cpu"></i>
                            <p>Identify Chip</p>
                        </div>
                        <i class="bi bi-arrow-right help-arrow"></i>
                        <div class="help-step">
                            <i class="bi bi-card-heading"></i>
                            <p>Click Card</p>
                        </div>
                        <i class="bi bi-arrow-right help-arrow"></i>
                        <div class="help-step">
                            <i class="bi bi-check-circle"></i>
                            <p>Continue</p>
                        </div>
                    </div>
                    <!-- End Updated Diagram -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 2 Modal -->
    <div class="modal fade" id="stuckModalStep2" tabindex="-1" aria-labelledby="stuckModalStep2Label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stuckModalStep2Label">Help: Connecting Device</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Establish communication between the browser and your ESP board.</p>
                     <ul>
                        <li>Connect board via <strong>USB data cable</strong>.</li>
                        <li>Put board into <strong>bootloader/download mode</strong> (Hold BOOT, press RESET, then release BOOT).</li>
                        <li>Alternatively, some boards enter bootloader by just holding BOOT while plugging in.</li>
                        <li>Click "Connect" button here.</li>
                        <li>Select the correct serial port in the browser popup.</li>
                        <li><strong>Troubleshooting:</strong> Try a different USB cable/port, install drivers for your USB-to-serial chip (CP210x/CH340). Verify you're in bootloader mode and try a lower baud rate.</li>
                        <li>If you're still having trouble, try a different browser.</li>
                    </ul>
                    <!-- Updated Diagram -->
                    <div class="help-diagram">
                         <div class="help-step">
                            <i class="bi bi-usb-plug"></i>
                            <p>Connect USB</p>
                        </div>
                        <i class="bi bi-arrow-right help-arrow"></i>
                        <div class="help-step">
                            <i class="bi bi-download"></i>
                            <p>Enter Boot Mode</p>
                        </div>
                        <i class="bi bi-arrow-right help-arrow"></i>
                        <div class="help-step">
                            <i class="bi bi-box-arrow-up-right"></i>
                            <p>Click Connect</p>
                        </div>
                         <i class="bi bi-arrow-right help-arrow"></i>
                        <div class="help-step">
                            <i class="bi bi-list-ul"></i>
                            <p>Select Port</p>
                        </div>
                        <i class="bi bi-arrow-right help-arrow"></i>
                        <div class="help-step">
                            <i class="bi bi-check-circle"></i>
                            <p>Connected!</p>
                        </div>
                    </div>
                     <!-- End Updated Diagram -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 3 Modal -->
    <div class="modal fade" id="stuckModalStep3" tabindex="-1" aria-labelledby="stuckModalStep3Label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stuckModalStep3Label">Help: Configuring Firmware</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Select the firmware file(s) to flash.</p>
                     <ul>
                        <li>Usually, only the <strong>Application</strong> (`.bin`) file is needed.</li>
                        <li>Select the "Application" toggle.</li>
                        <li>Click and upload your `.bin` file to the upload area.</li>
                        <li>Verify the offset <strong>Address</strong> (e.g., `0x10000`).</li>
                        <li>Only add Bootloader/Partition files if specifically required.</li>
                        <li>"Erase all flash" is recommended for clean flashing and automatically enabled.</li>
                    </ul>
                     <!-- Updated Diagram -->
                    <div class="help-diagram">
                        <div class="help-step">
                            <i class="bi bi-toggles"></i>
                            <p>Select Type</p>
                        </div>
                         <i class="bi bi-arrow-right help-arrow"></i>
                        <div class="help-step">
                            <i class="bi bi-upload"></i>
                            <p>Upload File</p>
                        </div>
                        <i class="bi bi-arrow-right help-arrow"></i>
                        <div class="help-step">
                            <i class="bi bi-geo-alt"></i>
                            <p>Check Address</p>
                        </div>
                         <i class="bi bi-arrow-right help-arrow"></i>
                         <div class="help-step">
                             <i class="bi bi-gear"></i>
                             <p>(Opt.) Options</p>
                         </div>
                        <i class="bi bi-arrow-right help-arrow"></i>
                        <div class="help-step">
                            <i class="bi bi-check-square"></i>
                            <p>Check Erase</p>
                        </div>
                        <i class="bi bi-arrow-right help-arrow"></i>
                        <div class="help-step">
                             <i class="bi bi-arrow-right-circle"></i>
                             <p>Continue</p>
                         </div>
                    </div>
                    <!-- End Updated Diagram -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Step 4 Modal -->
    <div class="modal fade" id="stuckModalStep4" tabindex="-1" aria-labelledby="stuckModalStep4Label" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stuckModalStep4Label">Help: Flashing</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Write the selected firmware to the device.</p>
                    <ul>
                        <li>Review the <strong>Flash Summary</strong>.</li>
                        <li>Click "Flash Firmware". Erasing may take time if checked.</li>
                        <li>Wait for the progress bar to complete. <strong>Do not disconnect!</strong></li>
                        <li>Tool will attempt to reset the device when finished.</li>
                        <li><strong>Troubleshooting:</strong> Check Output Log for errors. Try again, maybe using "Erase Flash" first. Check USB connection, power, addresses.</li>
                    </ul>
                    <!-- Updated Diagram -->
                    <div class="help-diagram">
                        <div class="help-step">
                            <i class="bi bi-card-checklist"></i>
                            <p>Review</p>
                        </div>
                        <i class="bi bi-arrow-right help-arrow"></i>
                        <div class="help-step">
                            <i class="bi bi-lightning-charge"></i>
                            <p>Click Flash</p>
                        </div>
                         <i class="bi bi-arrow-right help-arrow"></i>
                        <div class="help-step">
                            <i class="bi bi-hourglass-split"></i>
                            <p>Wait</p>
                        </div>
                        <i class="bi bi-arrow-right help-arrow"></i>
                         <div class="help-step">
                            <i class="bi bi-terminal"></i>
                            <p>(Opt.) Check Log</p>
                        </div>
                        <i class="bi bi-arrow-right help-arrow"></i>
                         <div class="help-step">
                            <i class="bi bi-check-circle"></i>
                            <p>Complete!</p>
                        </div>
                    </div>
                     <!-- End Updated Diagram -->
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>
 
    <!-- Scripts -->
    <script src="loading-animation.js"></script>
    
    <script type="module">
        import * as esptoolJS from 'https://unpkg.com/esptool-js@latest/bundle.js';
        window.esptoolJS = esptoolJS;
    </script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.7.1/jszip.min.js"></script>

    <!-- Flasher Logic -->
    <script src="flasher.js"></script>
    
    <!-- Custom JS (if any depends on flasher.js, keep it after) -->
    <script src="custom.js"></script>
    
</body>
</html> 